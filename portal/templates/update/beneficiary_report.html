{% extends 'update/base.html' %}
{% block tree_reg %} menu-open {% endblock %}
{% load static %}

{% block css %}
<link rel="stylesheet" href="https://cdn.datatables.net/1.13.6/css/jquery.dataTables.min.css">
<link rel="stylesheet" href="https://cdn.datatables.net/buttons/2.4.1/css/buttons.dataTables.min.css">
<link rel="stylesheet" href="https://cdn.datatables.net/responsive/2.5.0/css/responsive.dataTables.min.css">
<style>
    .btn-gradient-primary {
        background: linear-gradient(135deg, #4A7C3A, #288541);
        color: white;
        border: none;
        text-transform: uppercase;
        transition: all 0.3s ease;
    }
    .btn-gradient-primary:hover {
        background: linear-gradient(135deg, #3a6c2a, #187531);
        transform: translateY(-2px);
        box-shadow: 0 4px 8px rgba(74, 124, 58, 0.3);
    }
    .nav-tabs .nav-link {
        color: #288541;
        font-weight: 600;
        border: none;
        padding: 12px 24px;
    }
    .nav-tabs .nav-link.active {
        background: #288541;
        color: white;
        border-radius: 4px;
    }
    .stats-card {
        background: linear-gradient(135deg, #4A7C3A, #288541);
        color: white;
        border-radius: 0.5rem;
        padding: 1.5rem;
        text-align: center;
        margin-bottom: 1rem;
    }
    .stats-number {
        font-size: 2rem;
        font-weight: bold;
    }
    .detail-card {
        background: linear-gradient(135deg, #f8f9fa 0%, #e9ecef 100%);
        border-radius: 0.5rem;
        padding: 1.5rem;
        margin-bottom: 1rem;
    }
    .detail-label {
        font-weight: 600;
        color: #4A7C3A;
    }
    .beneficiary-image {
        width: 100px;
        height: 100px;
        object-fit: cover;
        border-radius: 8px;
        border: 2px solid #4A7C3A;
    }
    .action-buttons .btn {
        margin-right: 5px;
    }
    .data-table th {
        background-color: #4A7C3A;
        color: white;
    }
    .tab-pane {
        padding: 20px 0;
    }
    .content-wrapper {
        margin-left: 0;
    }
    .gender-badge {
        padding: 4px 8px;
        border-radius: 12px;
        font-size: 0.75rem;
        font-weight: 600;
    }
    .gender-male { background-color: #d1e7ff; color: #0d522f; }
    .gender-female { background-color: #f8d7da; color: #b02a37; }
    .gender-other { background-color: #e7f3ff; color: #0dcaf0; }
    .type-individual { background-color: #d1fae5; color: #065f46; }
    .type-group { background-color: #fef3c7; color: #92400e; }


    /* Override the sidebar margin for content wrapper */
body:not(.sidebar-mini-md):not(.sidebar-mini-xs):not(.layout-top-nav) .content-wrapper,
body:not(.sidebar-mini-md):not(.sidebar-mini-xs):not(.layout-top-nav) .main-footer,
body:not(.sidebar-mini-md):not(.sidebar-mini-xs):not(.layout-top-nav) .main-header {
    margin-left: 0 !important;
    transition: none !important;
}

/* If you also want to remove any padding that might be affected */
.content-wrapper {
    margin-left: 0 !important;
    padding-left: 0 !important;
}

/* Optional: If you want to make the content take full width */
.content-wrapper > .content {
    padding: 0 !important;
    margin: 0 !important;
}
</style>
{% endblock %}

{% block body %}
<div class="content-wrapper" style="padding: 10px 30px;">
    <div class="row">
        <div class="col-12">
            <div class="card">
                <div class="card-header d-flex justify-content-between align-items-center">
                    <h3 class="card-title">Beneficiary Management</h3>
                    <div class="action-buttons">
                        <button class="btn btn-gradient-primary" id="refreshBtn">
                            <i class="fas fa-sync-alt me-2"></i>Refresh
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Statistics Section -->
    <div class="row mb-4" id="statsContainer">
        <!-- Statistics will be loaded here -->
    </div>

    <!-- Tab Navigation -->
    <ul class="nav nav-tabs" role="tablist">
        <li class="nav-item">
            <a class="nav-link active" id="individual-tab" data-bs-toggle="tab" href="#individual" role="tab">
                <i class="fas fa-user me-2"></i>Individual Beneficiaries
            </a>
        </li>
        <li class="nav-item">
            <a class="nav-link" id="group-tab" data-bs-toggle="tab" href="#group" role="tab">
                <i class="fas fa-users me-2"></i>Group/Company Beneficiaries
            </a>
        </li>
    </ul>

    <!-- Tab Content -->
    <div class="tab-content">
        <!-- Individual Beneficiaries Tab -->
        <div class="tab-pane fade show active" id="individual" role="tabpanel">
            <div class="card">
                <div class="card-header">
                    <h5 class="card-title mb-0">Individual Beneficiaries</h5>
                </div>
                <div class="card-body">
                    <div class="table-responsive">
                        <table id="individualTable" class="table table-striped table-bordered datatable data-table" style="width:100%">
                            <thead>
                                <tr>
                                    <th>FARMER CODE</th>
                                    <th>NAME</th>
                                    <th>OTHER NAMES</th>
                                    <th>GENDER</th>
                                    <th>PHONE</th>
                                    <th>COMMUNITY</th>
                                    <th>DISTRICT</th>
                                    <th>CREATED DATE</th>
                                    <th>ENUMERATOR</th>
                                    <th>ACTIONS</th>
                                </tr>
                            </thead>
                            <tbody>
                                <!-- Data will be loaded via AJAX -->
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>

        <!-- Group Beneficiaries Tab -->
        <div class="tab-pane fade" id="group" role="tabpanel">
            <div class="card">
                <div class="card-header">
                    <h5 class="card-title mb-0">Group/Company Beneficiaries</h5>
                </div>
                <div class="card-body">
                    <div class="table-responsive">
                        <table id="groupTable" class="table table-striped table-bordered datatable data-table" style="width:100%">
                            <thead>
                                <tr>
                                    <th>FARMER CODE</th>
                                    <th>GROUP NAME</th>
                                    <th>REG NUMBER</th>
                                    <th>PRESIDENT</th>
                                    <th>PHONE</th>
                                    <th>COMMUNITY</th>
                                    <th>DISTRICT</th>
                                    <th>CREATED DATE</th>
                                    <th>ENUMERATOR</th>
                                    <th>ACTIONS</th>
                                </tr>
                            </thead>
                            <tbody>
                                <!-- Data will be loaded via AJAX -->
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Detail Modal -->
<div class="modal fade" id="detailModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header bg-success text-white">
                <h5 class="modal-title">Beneficiary Details</h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body" id="detailModalContent">
                <!-- Content will be loaded here -->
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block js %}
<script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
<script src="https://cdn.datatables.net/1.13.6/js/jquery.dataTables.min.js"></script>
<script src="https://cdn.datatables.net/buttons/2.4.1/js/dataTables.buttons.min.js"></script>
<script src="https://cdn.datatables.net/buttons/2.4.1/js/buttons.html5.min.js"></script>
<script src="https://cdn.datatables.net/buttons/2.4.1/js/buttons.print.min.js"></script>
<script src="https://cdn.datatables.net/responsive/2.5.0/js/dataTables.responsive.min.js"></script>
<script>
$(document).ready(function() {
    let individualTable, groupTable;

    // Initialize Individual Table
    individualTable = $('#individualTable').DataTable({
        processing: true,
        serverSide: true,
        ajax: {
            url: "/api/beneficiaries/datatable/",
            type: "GET",
            data: function(d) {
                d.beneficiary_type = 'individual';
            }
        },
        columns: [
            { 
                data: 'farmer_code',
                render: function(data) {
                    return `<strong>${data}</strong>`;
                }
            },
            { 
                data: 'name',
                render: function(data) {
                    return data || 'N/A';
                }
            },
            { 
                data: 'other_names',
                render: function(data) {
                    return data || 'N/A';
                }
            },
            { 
                data: 'gender',
                render: function(data) {
                    if (!data || data === 'na') return 'N/A';
                    const genderClass = data.toLowerCase().includes('male') ? 'gender-male' : 
                                      data.toLowerCase().includes('female') ? 'gender-female' : 'gender-other';
                    return `<span class="gender-badge ${genderClass}">${data}</span>`;
                }
            },
            { 
                data: 'phone',
                render: function(data) {
                    return data || 'N/A';
                }
            },
            { 
                data: 'community',
                render: function(data) {
                    return data || 'N/A';
                }
            },
            { 
                data: 'district',
                render: function(data) {
                    return data || 'N/A';
                }
            },
            { 
                data: 'created_date',
                render: function(data) {
                    return data || 'N/A';
                }
            },
            { 
                data: 'enumerator',
                render: function(data) {
                    return data || 'N/A';
                }
            },
            {
                data: 'id',
                orderable: false,
                render: function(data, type, row) {
                    return `
                        <div class="btn-group">
                            <button class="btn btn-sm btn-success view-btn" data-id="${data}" title="View Details">
                                <i class="fas fa-eye"></i>
                            </button>
                            
                            <button class="btn btn-sm btn-danger delete-btn" data-id="${data}" title="Delete">
                                <i class="fas fa-trash"></i>
                            </button>
                        </div>
                    `;
                }
            }
        ],
        dom: 'Bfrtip',
        buttons: [
            {
                extend: 'copy',
                text: '<i class="fas fa-copy"></i> Copy',
                className: 'btn btn-sm btn-outline-secondary'
            },
            {
                extend: 'csv',
                text: '<i class="fas fa-file-csv"></i> CSV',
                className: 'btn btn-sm btn-outline-success'
            },
            {
                extend: 'excel',
                text: '<i class="fas fa-file-excel"></i> Excel',
                className: 'btn btn-sm btn-outline-success'
            },
            {
                extend: 'pdf',
                text: '<i class="fas fa-file-pdf"></i> PDF',
                className: 'btn btn-sm btn-outline-danger'
            },
            {
                text: '<i class="fas fa-sync-alt"></i> Refresh',
                className: 'btn btn-sm btn-outline-info',
                action: function(e, dt, node, config) {
                    dt.ajax.reload();
                }
            }
        ],
        pageLength: 10,
        responsive: true
    });

    // Initialize Group Table
    groupTable = $('#groupTable').DataTable({
        processing: true,
        serverSide: true,
        ajax: {
            url: "/api/beneficiaries/datatable/",
            type: "GET",
            data: function(d) {
                d.beneficiary_type = 'group';
            }
        },
        columns: [
            { 
                data: 'farmer_code',
                render: function(data) {
                    return `<strong>${data}</strong>`;
                }
            },
            { 
                data: 'group_name',
                render: function(data) {
                    return data || 'N/A';
                }
            },
            { 
                data: 'reg_number',
                render: function(data) {
                    return data || 'N/A';
                }
            },
            { 
                data: 'president',
                render: function(data) {
                    return data || 'N/A';
                }
            },
            { 
                data: 'phone',
                render: function(data) {
                    return data || 'N/A';
                }
            },
            { 
                data: 'community',
                render: function(data) {
                    return data || 'N/A';
                }
            },
            { 
                data: 'district',
                render: function(data) {
                    return data || 'N/A';
                }
            },
            { 
                data: 'created_date',
                render: function(data) {
                    return data || 'N/A';
                }
            },
            { 
                data: 'enumerator',
                render: function(data) {
                    return data || 'N/A';
                }
            },
            {
                data: 'id',
                orderable: false,
                render: function(data, type, row) {
                    return `
                        <div class="btn-group">
                            <button class="btn btn-sm btn-success view-btn" data-id="${data}" title="View Details">
                                <i class="fas fa-eye"></i>
                            </button>
                            
                            <button class="btn btn-sm btn-danger delete-btn" data-id="${data}" title="Delete">
                                <i class="fas fa-trash"></i>
                            </button>
                        </div>
                    `;
                }
            }
        ],
        dom: 'Bfrtip',
        buttons: [
            {
                extend: 'copy',
                text: '<i class="fas fa-copy"></i> Copy',
                className: 'btn btn-sm btn-outline-secondary'
            },
            {
                extend: 'csv',
                text: '<i class="fas fa-file-csv"></i> CSV',
                className: 'btn btn-sm btn-outline-success'
            },
            {
                extend: 'excel',
                text: '<i class="fas fa-file-excel"></i> Excel',
                className: 'btn btn-sm btn-outline-primary'
            },
            {
                extend: 'pdf',
                text: '<i class="fas fa-file-pdf"></i> PDF',
                className: 'btn btn-sm btn-outline-danger'
            },
            {
                text: '<i class="fas fa-sync-alt"></i> Refresh',
                className: 'btn btn-sm btn-outline-info',
                action: function(e, dt, node, config) {
                    dt.ajax.reload();
                }
            }
        ],
        pageLength: 10,
        responsive: true
    });

    // Load statistics
    function loadStats() {
        $.ajax({
            url: "/api/beneficiaries/stats/",
            type: "GET",
            success: function(response) {
                if (response.success) {
                    const stats = response.stats;
                    const statsContainer = $('#statsContainer');
                    
                    statsContainer.empty();
                    
                    const statsCards = [
                        {
                            title: 'Total Beneficiaries',
                            value: stats.total_beneficiaries.toLocaleString(),
                            icon: 'fas fa-users',
                            color: 'primary'
                        },
                        {
                            title: 'Individual Beneficiaries',
                            value: stats.total_individuals.toLocaleString(),
                            icon: 'fas fa-user',
                            color: 'success'
                        },
                        {
                            title: 'Group Beneficiaries',
                            value: stats.total_groups.toLocaleString(),
                            icon: 'fas fa-users',
                            color: 'info'
                        },
                        {
                            title: 'Recent Registrations (30 days)',
                            value: (stats.recent_individuals + stats.recent_groups).toLocaleString(),
                            icon: 'fas fa-calendar-plus',
                            color: 'warning'
                        }
                    ];
                    
                    statsCards.forEach(function(card) {
                        statsContainer.append(`
                            <div class="col-md-3">
                                <div class="stats-card">
                                    <i class="${card.icon} fa-2x mb-2"></i>
                                    <h3 class="stats-number">${card.value}</h3>
                                    <p>${card.title}</p>
                                </div>
                            </div>
                        `);
                    });
                }
            }
        });
    }

    // View button click handler
    $(document).on('click', '.view-btn', function() {
        const beneficiaryId = $(this).data('id');
        loadBeneficiaryDetails(beneficiaryId);
    });

    // Load beneficiary details
    function loadBeneficiaryDetails(beneficiaryId) {
        $.ajax({
            url: `/api/beneficiaries/detail/${beneficiaryId}/`,
            type: "GET",
            success: function(response) {
                if (response.success) {
                    const beneficiary = response.beneficiary;
                    let detailHtml = '';

                    if (beneficiary.type_beneficiary && beneficiary.type_beneficiary.toLowerCase().includes('group')) {
                        // Group beneficiary details
                        detailHtml = `
                            <div class="row">
                                <div class="col-md-12">
                                    <h4>Group/Company Information</h4>
                                    <div class="detail-card">
                                        <div class="row">
                                            <div class="col-md-6">
                                                <p><span class="detail-label">Group Name:</span> ${beneficiary.group_info.name || 'N/A'}</p>
                                                <p><span class="detail-label">Registration Number:</span> ${beneficiary.group_info.reg_number || 'N/A'}</p>
                                                <p><span class="detail-label">President:</span> ${beneficiary.group_info.president || 'N/A'}</p>
                                                <p><span class="detail-label">Secretary:</span> ${beneficiary.group_info.secretary || 'N/A'}</p>
                                            </div>
                                            <div class="col-md-6">
                                                <p><span class="detail-label">Directors:</span> ${beneficiary.group_info.directors || 'N/A'}</p>
                                                <p><span class="detail-label">Phone:</span> ${beneficiary.group_info.phone || 'N/A'}</p>
                                                <p><span class="detail-label">Email:</span> ${beneficiary.group_info.email || 'N/A'}</p>
                                                <p><span class="detail-label">Address:</span> ${beneficiary.group_info.address || 'N/A'}</p>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        `;
                    } else {
                        // Individual beneficiary details
                        detailHtml = `
                            <div class="row">
                                <div class="col-md-12">
                                    <h4>Personal Information</h4>
                                    <div class="detail-card">
                                        <div class="row">
                                            <div class="col-md-6">
                                                <p><span class="detail-label">First Name:</span> ${beneficiary.personal_info.first_name || 'N/A'}</p>
                                                <p><span class="detail-label">Surname:</span> ${beneficiary.personal_info.surname || 'N/A'}</p>
                                                <p><span class="detail-label">Other Names:</span> ${beneficiary.personal_info.other_names || 'N/A'}</p>
                                                <p><span class="detail-label">Gender:</span> ${beneficiary.personal_info.gender || 'N/A'}</p>
                                            </div>
                                            <div class="col-md-6">
                                                <p><span class="detail-label">Date of Birth:</span> ${beneficiary.personal_info.dob || 'N/A'}</p>
                                                <p><span class="detail-label">Age:</span> ${beneficiary.personal_info.age || 'N/A'}</p>
                                                <p><span class="detail-label">Phone:</span> ${beneficiary.personal_info.phone || 'N/A'}</p>
                                                <p><span class="detail-label">Email:</span> ${beneficiary.personal_info.email || 'N/A'}</p>
                                            </div>
                                        </div>
                                        <p><span class="detail-label">Address:</span> ${beneficiary.personal_info.address || 'N/A'}</p>
                                    </div>
                                </div>
                            </div>

                            <div class="row">
                                <div class="col-md-12">
                                    <h4>Next of Kin Information</h4>
                                    <div class="detail-card">
                                        <div class="row">
                                            <div class="col-md-6">
                                                <p><span class="detail-label">Name:</span> ${beneficiary.next_of_kin.name || 'N/A'}</p>
                                                <p><span class="detail-label">Relationship:</span> ${beneficiary.next_of_kin.relationship || 'N/A'}</p>
                                                <p><span class="detail-label">Gender:</span> ${beneficiary.next_of_kin.gender || 'N/A'}</p>
                                            </div>
                                            <div class="col-md-6">
                                                <p><span class="detail-label">Phone:</span> ${beneficiary.next_of_kin.phone || 'N/A'}</p>
                                                <p><span class="detail-label">Date of Birth:</span> ${beneficiary.next_of_kin.dob || 'N/A'}</p>
                                            </div>
                                        </div>
                                        <p><span class="detail-label">Address:</span> ${beneficiary.next_of_kin.address || 'N/A'}</p>
                                    </div>
                                </div>
                            </div>
                        `;
                    }

                    // Common information for both types
                    detailHtml += `
                        <div class="row">
                            <div class="col-md-12">
                                <h4>Location Information</h4>
                                <div class="detail-card">
                                    <div class="row">
                                        <div class="col-md-6">
                                            <p><span class="detail-label">Community:</span> ${beneficiary.location_info.community || 'N/A'}</p>
                                            <p><span class="detail-label">District:</span> ${beneficiary.location_info.district || 'N/A'}</p>
                                        </div>
                                        <div class="col-md-6">
                                            <p><span class="detail-label">Forest District:</span> ${beneficiary.location_info.forest_district || 'N/A'}</p>
                                            <p><span class="detail-label">Stool Family:</span> ${beneficiary.location_info.stool_family || 'N/A'}</p>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <div class="row">
                            <div class="col-md-12">
                                <h4>Additional Information</h4>
                                <div class="detail-card">
                                    <div class="row">
                                        <div class="col-md-6">
                                            <p><span class="detail-label">Farmer Code:</span> ${beneficiary.farmer_code || 'N/A'}</p>
                                            <p><span class="detail-label">Enumerator:</span> ${beneficiary.enumerator || 'N/A'}</p>
                                        </div>
                                        <div class="col-md-6">
                                            <p><span class="detail-label">Organisation:</span> ${beneficiary.organisation || 'N/A'}</p>
                                            <p><span class="detail-label">Created Date:</span> ${beneficiary.created_date || 'N/A'}</p>
                                        </div>
                                    </div>
                                    <p><span class="detail-label">Witness Name:</span> ${beneficiary.witness_info.name || 'N/A'}</p>
                                    <p><span class="detail-label">Witness Phone:</span> ${beneficiary.witness_info.phone || 'N/A'}</p>
                                </div>
                            </div>
                        </div>
                    `;

                    $('#detailModalContent').html(detailHtml);
                    $('#detailModal').modal('show');
                } else {
                    alert('Error loading beneficiary details: ' + response.error);
                }
            },
            error: function() {
                alert('Error loading beneficiary details');
            }
        });
    }

    // Refresh button click
    $('#refreshBtn').click(function() {
        individualTable.ajax.reload();
        groupTable.ajax.reload();
        loadStats();
    });

    // Tab change handler to refresh the appropriate table
    $('a[data-bs-toggle="tab"]').on('shown.bs.tab', function(e) {
        const target = $(e.target).attr("href");
        if (target === '#individual') {
            individualTable.ajax.reload();
        } else if (target === '#group') {
            groupTable.ajax.reload();
        }
    });

    // Initial load
    loadStats();
});
</script>
{% endblock %}